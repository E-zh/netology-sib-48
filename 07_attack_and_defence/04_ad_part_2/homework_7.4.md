# Специалист по информационной безопасности: специализация Pentest
## Модуль 7. Attack & Defence
### Желобанов Егор SIBDEF-48

# Домашнее задание к занятию «7.4. Active Directory. Часть 2»

### Задание 1

Проведите самостоятельный аудит установленного на прошлом занятии DC, опираясь на лекцию. 

Проведете проверку системы при помощи [DCDiag.](https://learn.microsoft.com/ru-ru/windows-server/administration/windows-commands/dcdiag)

### Ответ:

Аудит DC начал с выполнения команды `dcdiag.exe /s:AD-NETOLOGY /test:dns /e /v /f:C:\Users\Администратор\Desktop\report1.txt`,
результат выполнения команды сохранился в файл [report1.txt](assets/report1.txt).

Ключ команды `/e` позволяет провести проверку по всем контроллерам домена, в нашем случае можно было не использовать,
а ключ `/v` - получить детальную информацию по проводимым проверкам.

Как видно из пройденной проверки, все тесты пройдены, но в некоторых есть предупреждения:

```text
Запуск проверки: KccEvent

         Возникло предупреждение. Код события (EventID): 0x80000603

            Время создания: 07/04/2025   20:39:35

            Строка события:

            Доменным службам Active Directory не удается отключить программный кэш записи на следующий жесткий диск. 


         Возникло предупреждение. Код события (EventID): 0x80000B46

            Время создания: 07/04/2025   12:39:10

            Строка события:

            Безопасность данного сервера каталогов можно существенно повысить, если настроить его на отклонение привязок LDAP SASL (согласование, Kerberos, NTLM или дайджест), не требующих подписи (проверки целостности), и простых привязок LDAP, которые  выполняются через открытое (не зашифрованное с помощью SSL/TLS) подключение. Даже если клиенты не используют такие привязки, настройка сервера на их отклонение улучшит его безопасность. 


         Возникло предупреждение. Код события (EventID): 0x80000BE1

            Время создания: 07/04/2025   12:39:10

            Строка события:

            Безопасность сервера каталогов можно существенно повысить, настроив на нем принудительную проверку токенов привязки канала,  получаемых в запросах LDAP-привязок через LDAPS-соединения. Даже если  никакие клиенты не отправляют запросы LDAP-привязок через LDAPS-соединение,  безопасность сервера улучшится после настройки такой проверки. 


         ......................... AD-NETOLOGY - пройдена проверка KccEvent
```

* Предупреждение "Доменным службам Active Directory не удается отключить программный кэш записи на следующий жесткий диск" - 
  это предупреждение не всегда указывает на критическую проблему, но может приводить к потере данных при нештатном завершении работы виртуальной машины,
  и больше связано с тем, что контроллер домена находится на ВМ в Virtualbox.

* Предупреждение "Безопасность данного сервера каталогов можно существенно повысить, если настроить его на отклонение
  привязок LDAP SASL (согласование, Kerberos, NTLM или дайджест), не требующих подписи (проверки целостности),
  и простых привязок LDAP, которые выполняются через открытое (не зашифрованное с помощью SSL/TLS) подключение. 
  Даже если клиенты не используют такие привязки, настройка сервера на их отклонение улучшит его безопасность" - решается
  включением подписи LDAP в Windows Server, как это сделать опубликовано [здесь](https://learn.microsoft.com/ru-ru/troubleshoot/windows-server/active-directory/enable-ldap-signing-in-windows-server),
  но в нашем случае тестового DC я не буду ее включать.

* Предупреждение "Безопасность сервера каталогов можно существенно повысить, настроив на нем принудительную проверку токенов
  привязки канала, получаемых в запросах LDAP-привязок через LDAPS-соединения. Даже если никакие клиенты не отправляют
  запросы LDAP-привязок через LDAPS-соединение, безопасность сервера улучшится после настройки такой проверки" - решается
  активацией LDAP over SSL (LDAPS) в Windows Server. Информацию об этом [нашел здесь](https://winitpro.ru/index.php/2014/10/02/aktiviruem-ldap-over-ssl-ldaps-v-windows-server-2012-r2/),
  включать также не буду.

* Предупреждение ниже указывает также на virtual hard drive, и критическим не является:
```text
Запуск проверки: SystemLog

         Возникло предупреждение. Код события (EventID): 0x80040022

            Время создания: 07/04/2025   20:39:35

            Строка события: Драйвер отключил буфер записи для устройства \Device\Harddisk0\DR0.
```

* Данное предупреждение у меня возникло, т.к. в настройках сетевой карты был указан в качестве DNS сервера ip-адрес роутера,
  т.к. 1-я сетевая карта у меня в режиме "Сетевой мост", а не NAT, и связано с небольшими особенностями среды выполнения этого
  домашнего задания. При замене адреса DNS на ip самого сервера, предупреждение более не появлялось:
```text
Возникло предупреждение. Код события (EventID): 0x000003F6

            Время создания: 07/04/2025   12:39:04

            Строка события:

            Разрешение имен для имени _ldap._tcp.dc._msdcs.netology.local. истекло после отсутствия ответа от настроенных серверов DNS.
```

* Данное предупреждение возникло, поскольку я не настраивал NTP, а также могло повлиять то, что DC есть ВМ в VirtualBox, и в настройках
  виртуальной машины нужно выключить синхронизацию времени с хостовой машиной:
```text
Возникло предупреждение. Код события (EventID): 0x0000000C

            Время создания: 07/04/2025   12:39:50

            Строка события:

            NTP-клиент поставщика времени: этот компьютер настроен на использование доменной иерархии для определения своего источника времени, но при этом он является эмулятором основного контроллера домена Active Directory для домена в корне леса, поэтому в доменной иерархии не существует компьютера, расположенного выше, который можно использовать как источник времени. Рекомендуется настроить надежную службу времени в корневом домене или вручную настроить основной контроллер домена Active Directory для синхронизации с внешним источником времени. В противном случае этот компьютер будет выступать в роли заслуживающего доверия источника времени в доменной иерархии. Если внешний источник времени не настроен или не используется для этого компьютера, можно отключить NTP-клиент.
```

Также провел дополнительный тест DNS, выполнив команду `cdiag.exe /s:AD-NETOLOGY /test:dns /DnsForwarders /v`, и сохранив
результат в файл [report2.txt](assets/report2.txt). 


#### Заключение
В целом, контроллер домена рабочий, большинство тестов утилитой [DcDiag] пройдены с положительным результатом.
Естественно, т.к. сервер тестовый, на нем не настроены NTP, LDAP, и другие полезные функции и средства безопасности.

В соответствии с материалом лекции, также были настроены:

* Длина пароля пользователей - минимум 12 символов
* Возраст пароля - 40 дней
* Включена корзина для AD

На мой взгляд, аудит данного сервера пройден с неплохим положительным результатом.
